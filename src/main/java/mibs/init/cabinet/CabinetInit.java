/*
 * This Java source file was generated by the Gradle 'init' task.
 */
package mibs.init.cabinet;

import java.awt.BorderLayout;
import java.awt.Color;
import java.awt.ComponentOrientation;
import java.awt.Dimension;
import java.awt.FlowLayout;
import java.awt.Font;
import java.awt.GridLayout;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.lang.reflect.Field;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.text.MessageFormat;
import java.util.ArrayList;
import java.util.Base64;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.ResourceBundle;
import java.util.concurrent.TimeoutException;
import java.util.function.Consumer;
import java.util.zip.ZipEntry;
import java.util.zip.ZipOutputStream;

import javax.swing.AbstractButton;
import javax.swing.Box;
import javax.swing.BoxLayout;
import javax.swing.GroupLayout;
import javax.swing.JButton;
import javax.swing.JComponent;
import javax.swing.JFrame;
import javax.swing.JLabel;
import javax.swing.JPanel;
import javax.swing.JTextField;

import org.apache.commons.compress.archivers.sevenz.SevenZArchiveEntry;
import org.apache.commons.compress.archivers.sevenz.SevenZOutputFile;
import org.apache.commons.io.FilenameUtils;
import org.apache.commons.io.IOUtils;
import org.apache.commons.lang3.SerializationUtils;

import com.rabbitmq.client.Channel;
import com.rabbitmq.client.Connection;
import com.rabbitmq.client.ConnectionFactory;
import com.rabbitmq.client.DeliverCallback;

public class CabinetInit extends JFrame implements ActionListener, QueueHandler {

	private static final long serialVersionUID = 1L;
	
	private static final int textWidth = 240;
	private static final int textHeight= 24;
	
	private static final String EXCHANGE_NAME = "amq.direct";
	private static final String SRC_PATH = "/home/admin2/storage/DICOM/1554293765-8E26DF76/temp";
	

	private JPanel statusBar = new JPanel( new FlowLayout(FlowLayout.LEFT)  );
	
	private JPanel panel = new JPanel();
	private JPanel toolBarPanel = new JPanel( );
	private JPanel panel0 = new JPanel(new FlowLayout(FlowLayout.LEFT) );
	private CPanel panel1 = new CPanel( );
	private CPanel panel2 = new CPanel();
	
	private List<CPanel> panels = new ArrayList<>();
	private List<JButton> buttons = new ArrayList<>();
	
	
	private JLabel lb1 =  new JLabel();;
	private JLabel lb2 = new JLabel();
	
	private JLabel labelFirstName = new JLabel();
	private JLabel labelPatronymic = new JLabel();
	private JLabel labelLastName = new JLabel();
	private JLabel labelBirthday = new JLabel();
	
	private JLabel labelEmail = new JLabel();
	private JLabel labelEmail2 = new JLabel();
	
	private JLabel labelConclusion = new JLabel();
	private JLabel labelExploration = new JLabel();
	private JLabel labelExplorationID = new JLabel();
	
	private JTextField textFirstName = new JTextField();
	private JTextField textPatronymic = new JTextField();
	private JTextField textLastName = new JTextField();
	private JTextField textBirthday  = new JTextField();
	
	private JTextField textEmail  = new JTextField();
	private JTextField textEmail2  = new JTextField();
	
	private JTextField textConclusion  = new JTextField();
	private JTextField textExploration  = new JTextField();

	private JTextField textExplorationID  = new JTextField();
	
	
	private JButton b1, b2, b3, b4, b5;
	private JButton sendButton1, sendButton2, sendButton3, sendButton4;
	
	private Channel channel = null;
	private Connection connection = null;
	
	public CabinetInit() {
		
		super( PROG_CAPTION );
			
		initResponceCommands( lb2 );
		initControls();
		
		setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
		panel.setOpaque(true);
		setContentPane(panel);
		
		//setLayout();
		
		//setSize(new Dimension(600, 250));
		pack();
		setVisible(true);
		setResizable(false);
		try {
			
			init_rabbitmq_connection_and_subscribe( host ,login ,password);
			initActionCommands( channel, lb2 );
			say_connection_active( host );
		} catch (IOException e) {
			say_connection_error( host );
		} catch (TimeoutException e) {
			say_connection_error( host );
		}
		
	}


	private void say_connection_active( String host ) {
		lb1.setText(  MessageFormat.format( bundle.getString( CONNECTION_ACTIVATED ), host ) );
		lb1.setForeground(Color.black);
	}
	private void say_connection_error(String host) {
		lb1.setText( MessageFormat.format( bundle.getString( ERROR_CONNECTION ), host ) );
		lb1.setForeground( Color.red );
	}
	
	private void setLayoutPanel2() {
		GroupLayout layout = new GroupLayout(panel2);
		panel2.setLayout(layout);
		layout.setAutoCreateGaps(true);
		layout.setAutoCreateContainerGaps(true);
		layout.setHorizontalGroup(layout.createParallelGroup(  )
			      .addGroup(layout.createSequentialGroup()
			    		  .addGroup(layout.createParallelGroup( )
			    				  .addComponent(labelEmail)	
			    	    		  .addComponent(labelExplorationID)	
			    	    		  .addComponent(labelConclusion)
			    	    		
			    			 )
			    		  .addGroup(layout.createParallelGroup(  )
			    				  .addComponent(textEmail)	
			    	    		  .addComponent(textExplorationID)
			    	    		  .addComponent(textConclusion)
			    	    		
			    			 )
			    		  )
			     
			      .addComponent( sendButton2 )
	);
	layout.setVerticalGroup(layout.createSequentialGroup()
			
			   .addGroup(layout.createParallelGroup()
					  .addComponent(labelEmail)	
					  .addComponent(textEmail)
					  
				)
			   .addGroup(layout.createParallelGroup()
			   
					  .addComponent(labelExplorationID)	
					  .addComponent(textExplorationID)	
				 )
			   .addGroup(layout.createParallelGroup()
					  .addComponent(labelConclusion)	
					  .addComponent(textConclusion)	  
						  
				)
			   .addComponent( sendButton2 )
			  
			);
	}
	
	private void setLayoutPanel1() {
		
		GroupLayout layout = new GroupLayout(panel1);
		panel1.setLayout(layout);
		layout.setAutoCreateGaps(true);
		layout.setAutoCreateContainerGaps(true);
		layout.setHorizontalGroup(layout.createParallelGroup(  )
			      .addComponent(lb1)
			      .addGroup(layout.createSequentialGroup()
			    		  .addGroup(layout.createParallelGroup( )
			    				  .addComponent(labelFirstName)	
			    	    		  .addComponent(labelLastName)	
			    	    		  .addComponent(labelPatronymic)
			    	    		  .addComponent(labelBirthday)
			    	    		  .addComponent(labelEmail)
			    			 )
			    		  .addGroup(layout.createParallelGroup(  )
			    				  .addComponent(textFirstName)	
			    	    		  .addComponent(textLastName)
			    	    		  .addComponent(textPatronymic)
			    	    		  .addComponent(textBirthday)
			    	    		  .addComponent(textEmail)
			    			 )
			    		  )
			      .addComponent(lb2)
			      .addComponent(sendButton1)
	);
	layout.setVerticalGroup(layout.createSequentialGroup()
			   .addComponent(lb1)
			   .addGroup(layout.createParallelGroup()
					  .addComponent(labelFirstName)	
					  .addComponent(textFirstName)
					  
				)
			   .addGroup(layout.createParallelGroup()
			   
					  .addComponent(labelLastName)	
					  .addComponent(textLastName)	
				 )
			   .addGroup(layout.createParallelGroup()
						  .addComponent(labelPatronymic)	
						  .addComponent(textPatronymic)	  
						  
				)
			   .addGroup(layout.createParallelGroup()
					   .addComponent(labelBirthday)	
	    	    	   .addComponent(textBirthday)
					 
				  )
			   .addGroup(layout.createParallelGroup(GroupLayout.Alignment.BASELINE)
					   .addComponent(labelEmail)	
	    	    	   .addComponent(textEmail)
					 
				  )
			   .addComponent(lb2)
			   .addComponent(sendButton1)
			  
			);
	}
	private void setLayoutPanel() {
		GroupLayout layout = new GroupLayout(panel);
		panel.setLayout(layout);
		layout.setAutoCreateGaps(true);
		layout.setAutoCreateContainerGaps(true);
		layout.setHorizontalGroup(layout.createParallelGroup(  )
			      .addComponent(toolBarPanel)
			      .addComponent(panel0)
			      .addComponent(statusBar)
			      .addGap(20)
				);
		layout.setVerticalGroup(layout.createSequentialGroup()
			   .addComponent(toolBarPanel)
			   .addComponent(panel0)
			   .addComponent(statusBar)
			   .addGap(20)
			);
	}
	private void togglePanels(String cmd) {
		
		panels.forEach(s->{
			s.setVisible( false );
			if (s.getBindCommand().equals(cmd)) {
				s.setVisible( true );
			}
		});
		buttons.forEach(s->{
			s.setEnabled( true );
			if (s.getActionCommand().equals(cmd)) {
				s.setEnabled( false );
			}
		});
		
	}
	private void initControls() {
	
		statusBar.setPreferredSize(new Dimension(200, 16));
		statusBar.setBackground(Color.red);
		statusBar.add(new JLabel("Status:"));
		
		sendButton1 = new JButton(bundle.getString(BUTTON_SEND));
		sendButton2 = new JButton(bundle.getString(BUTTON_SEND));
				
	//	panel1.setVisible( false );
		panel1.setBindCommand(CMD_INIT_CABINET);
		panel2.setVisible( false );
		panel2.setBindCommand(CMD_ADD_CONCLUSION);
		
		panels.add(panel1);
		panels.add(panel2);
		
		labelFirstName.setText( bundle.getString(FIRST_NAME) + ":" );
		//labelFirstName.setLayout(  new FlowLayout(FlowLayout.RIGHT)  );
		
		labelPatronymic.setText( bundle.getString(PATRONYMIC) +":" );
		labelLastName.setText( bundle.getString(LAST_NAME) +":" );
		labelBirthday.setText( bundle.getString(BIRTHDAY) +":" );
		
		labelEmail.setText( bundle.getString(EMAIL) +":" );
		labelEmail2.setText( bundle.getString(EMAIL) +":" );
		
		labelConclusion.setText( bundle.getString( CONCLUSION ) +":" );
		labelExploration.setText( bundle.getString( EXPLORATION ) +":" );
		labelExplorationID.setText( bundle.getString( EXPLORATIONID ) +":" );
		
		textFirstName.setPreferredSize(new Dimension(textWidth, textHeight));
		textPatronymic.setPreferredSize(new Dimension(textWidth, textHeight));
		textLastName.setPreferredSize(new Dimension(textWidth, textHeight));
		textBirthday.setPreferredSize(new Dimension(textWidth, textHeight));
		textEmail.setPreferredSize(new Dimension(textWidth, textHeight));
		textExplorationID.setPreferredSize(new Dimension(textWidth, textHeight));
		textConclusion.setPreferredSize(new Dimension(textWidth, textHeight));
		
		lb2.setText("Cabinet state:");
		b1 = new JButton(bundle.getString(BUTTON_INIT_CABINET));
		b1.setActionCommand(CMD_INIT_CABINET);
		b1.addActionListener(this);
		b1.setEnabled(false);
		
		b2 = new JButton(bundle.getString(BUTTON_ADD_CONCLUSION));
		b2.setActionCommand(CMD_ADD_CONCLUSION);
		b2.addActionListener(this);
		
		b3 = new JButton(bundle.getString(BUTTON_ADD_EXPLORATION));
		b3.setActionCommand(CMD_ADD_EXPLORATION);
		b3.addActionListener(this);
		
		b4 = new JButton(bundle.getString(BUTTON_PROLONG_CABINET));
		b4.setActionCommand(CMD_PROLONG_CABINET);
		b4.addActionListener(this);
		
		b5 = new JButton(bundle.getString(BUTTON_BLOCK_CABINET));
		b5.setActionCommand(CMD_BLOCK_CABINET);
		b5.addActionListener(this);

		buttons.add(b1);
		buttons.add(b2);
		buttons.add(b3);
		buttons.add(b4);
		buttons.add(b5);
		
		toolBarPanel.setLayout(new BoxLayout(toolBarPanel, BoxLayout.X_AXIS));
		
		toolBarPanel.add(b1, BorderLayout.LINE_START);
		toolBarPanel.add(Box.createRigidArea(new Dimension(5, 0)));
		toolBarPanel.add(b2, BorderLayout.LINE_START);
		toolBarPanel.add(Box.createRigidArea(new Dimension(5, 0)));
		toolBarPanel.add(b3, BorderLayout.LINE_START);
		toolBarPanel.add(Box.createRigidArea(new Dimension(5, 0)));
		toolBarPanel.add(b4, BorderLayout.LINE_START);
		toolBarPanel.add(Box.createRigidArea(new Dimension(5, 0)));
		toolBarPanel.add(b5, BorderLayout.LINE_START);
		
		setLayoutPanel();
		setLayoutPanel1();
		setLayoutPanel2();
		
	
		 panel0.add( panel2 );
		 panel0.add( panel1 );
		// panel0.add(statusBar);
		
		
		
	}
	private  void init_rabbitmq_connection_and_subscribe(String host, String user, String password) throws IOException, TimeoutException {

		ConnectionFactory factory = new ConnectionFactory();
		factory.setHost( host );
		factory.setUsername( user );
		factory.setPassword( password );
		factory.setPort( 5672 );
		connection = factory.newConnection();
		channel = connection.createChannel();
		channel.queueDeclare("localin", true, false, false, null);
		channel.queueDeclare("localout", true, false, false, null);

		DeliverCallback deliverCallback = (consumerTag, delivery) -> {
			RabbitmqCommandMessage<?> msg = (RabbitmqCommandMessage<?>) SerializationUtils.deserialize(delivery.getBody());
			responceCommands.get( msg.getCommand() ).accept( (RabbitmqCommandMessage<Person>) msg );
		};
		channel.basicConsume("localout", true, deliverCallback, consumerTag -> {});

		System.out.println(" [*] Waiting for messages. To exit press CTRL+C");
	}
	private void make7Z() throws IOException {

		Files.list(Paths.get(SRC_PATH)).filter((s) -> !s.toString().endsWith("zip")).forEach((fn) -> {
			String zipName = FilenameUtils.removeExtension(fn.getFileName().toString()) + ".zip";
			try {
				ByteArrayOutputStream bos = new ByteArrayOutputStream();
				ZipOutputStream zipOut = new ZipOutputStream(bos);
				File fileToZip = new File(fn.toString());
				FileInputStream fis = new FileInputStream(fileToZip);
				ZipEntry zipEntry = new ZipEntry(fileToZip.getName());
				try {
					zipOut.putNextEntry(zipEntry);
					IOUtils.copy(fis, zipOut);
					zipOut.flush();
					bos.flush();
					zipOut.close();
					fis.close();
					byte[] bytes = bos.toByteArray();
					bos.close();
					RabbitmqDicomMessage msg = new RabbitmqDicomMessage(zipName, bytes);
					byte[] rc = SerializationUtils.serialize(msg);
					System.out.println(fn.getFileName().toString() + "  " + rc.length);
					channel.basicPublish(EXCHANGE_NAME, "", true, false, null, rc);
				} catch (IOException e) {
					e.printStackTrace();
				}

			} catch (FileNotFoundException e1) {

				e1.printStackTrace();
			}

		});
	}
	@Override
	public void actionPerformed(ActionEvent e) {
		
		System.out.println(e.getActionCommand());
		togglePanels( e.getActionCommand() );
/*		
		
		String command = e.getActionCommand();
		Person person = new Person(textFirstName.getText(),textSecondName.getText(), textLastName.getText(), textBirthday.getText(), textEmail.getText());
		RabbitmqCommandMessage<Person> msg = new RabbitmqCommandMessage<>( command, person);
		actionCommands.get( command ).accept( msg );
		
*/		
	}
	public String getGreeting() {
		return "Hello world.";
	}
	public static void main(String[] args) {
		javax.swing.SwingUtilities.invokeLater(new Runnable() {
			public void run() {
				new CabinetInit();
			}
		});
	}
	
}
